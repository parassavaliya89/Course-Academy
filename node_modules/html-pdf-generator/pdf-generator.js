const puppeteer=require("puppeteer-core"),templateInitializer=require("./helper"),logger=require("./logger");let _options,templateHelper,browser,page,pdfMergerDelegator;const pageEvents={pageerror:e=>{logger.writeLog({text:e,type:"ERROR"})},error:e=>{logger.writeLog({text:e,type:"ERROR"})},console:e=>{let t=e.args().map(e=>{if(e&&e._remoteObject.preview&&"error"!==e._remoteObject.preview.subtype){const t=e._remoteObject.preview.properties.reduce((e,t)=>(e[t.name]=t.value,e),{});return JSON.stringify(t,null,2)}return e&&e._remoteObject.description?e._remoteObject.description:e&&e._remoteObject.value?e._remoteObject.value:void 0});logger.writeLog({text:t.join(" "),type:e.type().substr(0,3).toUpperCase()})},response:e=>{/;base64,/gi.test(e.url())||logger.writeLog({text:`${e.status()} ${e.url()}`,type:"LOG"})},requestfailed:e=>{logger.writeLog({text:`${e.failure().errorText} ${e.url()}`,type:"ERROR"})}};async function init(){if(!browser||!page){if(!_options.URL_BROWSER)throw new Error("No target browser found");logger.writeLog({text:"Launching Browser",type:"LOG"}),browser=await puppeteer.launch({executablePath:_options.URL_BROWSER,product:_options.BROWSER_NAME}),logger.writeLog({text:"Starting Page",type:"LOG"}),page=await browser.newPage();for(let e in pageEvents)pageEvents.hasOwnProperty(e)&&page.on(e,pageEvents[e])}}async function closeBrowser(){if(templateHelper&&(templateHelper.dispose(),templateHelper=null),_options=null,page){for(let e in pageEvents)pageEvents.hasOwnProperty(e)&&page.off(e,pageEvents[e]);logger.writeLog({text:"Closing Browser",type:"LOG"}),page=null}browser&&(await browser.close(),browser=null)}function processTemplate(e){return new Promise(async(t,a)=>{try{await init();let a=await templateHelper.prepareTemplate(e),r=`http://localhost${_options.PORT&&":"+_options.PORT||""}/${a.fileName}.html`,o="application/pdf",p=null;if(a.urlTemplate&&(r=a.urlTemplate||r),logger.writeLog({text:"Loading "+r,type:"LOG"}),await page.goto(r,{waitUntil:"networkidle0"}),!0!==a.previewHTML){logger.writeLog({text:"Creating PDF",type:"LOG"});let e=await __getFooterTemplateFromTemplate(page.$eval.bind(page)),t=await __getHeaderTemplateFromTemplate(page.$eval.bind(page));const r={path:`${_options.PDF_DIR}/${a.fileName}.pdf`,format:"Letter",printBackground:!0,displayHeaderFooter:!0,footerTemplate:e.footerTemplate,headerTemplate:t.headerTemplate,preferCSSPageSize:a.preferCssPage||!1,margin:{top:t.marginTop,bottom:e.marginBottom,left:_options.printingMarginLeft,right:_options.printingMarginRight}};"horizontal"===a.orientation&&(r.landscape=!0,page.addStyleTag({content:"@page { size: A4 landscape; }"})),!0===a.preview&&delete r.path;const{buffer:n,totalPages:i}=await resolvePdfTotalPage({pagePdfGenFn:page.pdf.bind(page),pdfOptions:r,pageEvalFn:page.$eval.bind(page)});if(p=n,a.customPagesHeaderFooter){const n=[];for(const o in a.customPagesHeaderFooter){let p=a.customPagesHeaderFooter[o];t=await __getHeaderTemplateFromTemplate(page.$eval.bind(page),"#header-page-"+p),e=await __getFooterTemplateFromTemplate(page.$eval.bind(page),"#footer-page-"+p),r.footerTemplate=e.footerTemplate,r.headerTemplate=t.headerTemplate,r.margin.top=t.marginTop,r.margin.bottom=e.marginBottom,r.pageRanges=p.replace(/last|penult|first/g,e=>"penult"===e?i-1:"last"===e?i:"first"===e?1:e);try{n.push(await page.pdf(r))}catch(e){logger.writeLog({text:e.stack,type:"ERROR"})}}r.path&&templateHelper.deleteFile(r.path),pdfMergerDelegator?(p=await pdfMergerDelegator.merge(n),r.path&&await templateHelper.saveFile(r.path,p).catch(e=>{logger.writeLog({text:e,type:"ERROR"})})):(p=n,o="array/pdf")}}else o="text/html",p=Buffer.from(await page.content(),"utf8");t({fileName:a.fileName+".pdf",buffer:p,templateType:o}),templateHelper.deleteFile(`${_options.FILE_DIR}/${a.fileName}.html`)}catch(e){logger.writeLog({text:e.stack,type:"ERROR"}),a(e.message)}})}function resolvePdfTotalPage({pagePdfGenFn:e,pdfOptions:t,pageEvalFn:a}){return e(t).then(async r=>{if(pdfMergerDelegator){t.path&&templateHelper.deleteFile(t.path);const o=await pdfMergerDelegator.getPdfTotalPages(r);return await a("body",(e,t)=>{const a=document.createElement("script"),r=document.createTextNode(`\n                    const key = 'totalPages';\n                    reactiveInstance.extraParams[key] = ${t};\n                `);a.appendChild(r),e.appendChild(a)},o).then(async()=>({buffer:await e(t),totalPages:o}))}return{buffer:r,totalPages:0}})}async function __getFooterTemplateFromTemplate(e,t="#page-footer"){try{return await e(t,(e,t)=>{const a=e.outerHTML;return e.style.display="none",{footerTemplate:a,marginBottom:e.dataset.marginBottom||t.printingMarginBottom}},_options)}catch(e){logger.writeLog({text:e.message+". No footer template found",type:"WARN"})}return{footerTemplate:'<div style="margin: 0 13mm;display: flex; align-items: center; width:100%;justify-content: flex-end;">\n    <p style="font-size: 8px;text-align: right; align-self: flex-end;">\n        [<span class="pageNumber"></span>/<span class="totalPages"></span>]\n    </p>\n</div>',marginBottom:_options.printingMarginBottom}}async function __getHeaderTemplateFromTemplate(e,t="#page-header"){try{return await e(t,(e,t)=>{const a=e.outerHTML;return e.style.display="none",{headerTemplate:a,marginTop:e.dataset.marginTop||t.printingMarginTop}},_options)}catch(e){logger.writeLog({text:e.message+". No header template found",type:"WARN"})}return{headerTemplate:"<span></span>",marginTop:_options.printingMarginTop}}module.exports.initialize=function(e){const{BROWSER_NAME:t="chrome",URL_BROWSER:a,FILE_DIR:r,PDF_DIR:o,PORT:p,printingMarginTop:n="2.54cm",printingMarginBottom:i="2.54cm",printingMarginLeft:g="2.54cm",printingMarginRight:l="2.54cm",TEMPLATE_DIR:s,libs:m}=e;return _options={BROWSER_NAME:t,URL_BROWSER:a,FILE_DIR:r,PDF_DIR:o,PORT:p,printingMarginTop:n,printingMarginBottom:i,printingMarginLeft:g,printingMarginRight:l,TEMPLATE_DIR:s,libs:m},pdfMergerDelegator=e.pdfMergerDelegator,templateHelper=templateInitializer.initialize(_options),{processTemplate:processTemplate,dispose:async()=>{await closeBrowser()}}};