const fileHelper=require("./file-helper");let _options;function readTemplateContent(e){if(!e)throw new Error("No data provided");return new Promise((function(t,n){if("string"==typeof e)return t({template:e,templateName:"custom_template"});if(e.urlTemplate)return t({template:e.urlTemplate,templateName:e.$templateName||"external_template"});if(!e.$templateName)throw new Error("No $templateName provided");fileHelper.readFile(`${_options.TEMPLATE_DIR}/${e.$templateName}.html`).then(e=>e.toString("utf8")).then(n=>{let a,r,i,l;if(!("noData"in e)){var s=_getTemplateParameters(n);let t=n.split(/<\/body>\n*(<\/html>)*/gm);const o=e.$extraParams||{};s.extraParams=o,s.extraParams.totalPages=0,delete s.totalPages,a=o.orientation,r=o.previewHTML,i=o.preview,l=o.customPagesHeaderFooter,t.push(`\n                        ${_options.libs.map(e=>'<script src="'+e+'"><\/script>').join("\n")}\n                        <script>\n                            var reactiveInstance = null;\n                            window.onload = function () {\n                                var vueInit = {\n                                    mixins: window.mixins,\n                                    data: ${JSON.stringify(Object.assign(s,e.$parameters))}\n                                };\n                                // Allow style inside Vue root\n                                Vue.component('v-style', {\n                                    render: function (createElement) {\n                                        this.$slots.default.push({text:'* {\\n-webkit-print-color-adjust: exact;\\ncolor-adjust: exact;}'});\n                                        return createElement('style', this.$slots.default);\n                                    }\n                                });\n                                \n                                if (Vue.createApp) { // Vue v3\n                                    reactiveInstance = Vue.createApp(vueInit).mount('#app');\n                                    console.log("Vue v3.x");\n                                } else {\n                                    vueInit.el = '#app';\n                                    reactiveInstance = new Vue(vueInit);\n                                    console.log("Vue v2.x");\n                                }\n                            }\n                        <\/script></body></html>\n                    `),n=t.join("")}t({template:n,templateName:e.$templateName,orientation:a,previewHTML:r,preview:i,customPagesHeaderFooter:l})}).catch(n)}))}function saveOnTemp(e,t){var n=`${e}_${(new Date).getTime()}`;return"external_template"===e?Promise.resolve({fileName:n,urlTemplate:t}):fileHelper.saveFile(`${_options.FILE_DIR}/${n}.html`,t).then(()=>({fileName:n}))}function _getTemplateParameters(e){var t="",n=/((?:\{\{)\s*([\d\w$]+)\s*(?:\}\}))|(?:v-for=.+in\s)([\d\w$]+)|(?:\{\{)\s*[\d\w$\.]+\(([\d\w$]+),*[\w\s\d"'-]*\)(?:\}\})|(?:\{\{)([\d$\w]+)\.([\d$\w]+)(?:\}\})/gim,a={},r="";let i=null;for(;t=n.exec(e);)if(t)if(i=t.slice(0).filter(e=>e),i[0].match("v-for")){if(a[r=i[i.length-1]]&&Array.isArray(a[r])){a[r]=[Object.assign(a[r][0],getObjectParams(i,e))];continue}a[r]=[getObjectParams(i,e)]}else i[0].match(/(?:\{\{)([\d$\w]+)\.([\d$\w]+)(?:\}\})/)?a[i[1]]=getObjectParams(i[1],e):isNaN(i[i.length-1])&&(a[r=i.pop()]=`{{${r}}}`);return a}function getObjectParams(e,t){for(var n=new RegExp('"\\(*([\\d\\w$]+),*.*\\)*\\sin\\s'+e[e.length-1],"igm").exec(e[0])||[null,e],a=new RegExp(n[1]+"\\.([\\d\\w$]+)","igm"),r={};matched=a.exec(t);)if(matched){let e=matched.slice(0).pop();e&&(e=e.replace(/[\{\(\}\),]/g,"").split(/\s+/).shift()),r[e]=`{{${e}}}`}return r}module.exports.initialize=function(e){return _options={FILE_DIR:e.FILE_DIR,PDF_DIR:e.PDF_DIR,TEMPLATE_DIR:e.TEMPLATE_DIR,libs:e.libs||[]},_options.libs&&Array.isArray(_options.libs)&&0===_options.libs.filter(e=>/vue(\.min\.+?js)*/.test(e)).length&&_options.libs.unshift("https://cdn.jsdelivr.net/npm/vue"),{prepareTemplate:function(e){return fileHelper.ensureExitsDir([_options.FILE_DIR,_options.PDF_DIR]).then(()=>readTemplateContent(e).then(e=>saveOnTemp(e.templateName,e.template).then(t=>({...t,...e}))))},deleteFile:fileHelper.deleteFile,saveFile:fileHelper.saveFile,dispose:()=>{_options=null}}},module.exports.getTemplateParameters=function(e){return readTemplateContent({$templateName:e,noData:!0}).then(e=>_getTemplateParameters(e.template))};